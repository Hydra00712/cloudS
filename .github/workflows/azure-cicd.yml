name: Simple CI/CD (PublishProfile + SAS)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

env:
  AZURE_WEBAPP_NAME: engagement-app-demo
  PYTHON_VERSION: "3.12"
  STORAGE_ACCOUNT: stengml707

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Lint
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true

  upload-artifacts:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - uses: actions/checkout@v4
      - name: Show az version
        run: az --version
      - name: Upload cleaned_data.csv via SAS (no login)
        if: ${{ secrets.STORAGE_SAS_TOKEN != '' && hashFiles('data/processed/cleaned_data.csv') != '' }}
        run: |
          az storage blob upload \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --container-name cleaned-data \
            --name cleaned_data.csv \
            --file data/processed/cleaned_data.csv \
            --sas-token "${{ secrets.STORAGE_SAS_TOKEN }}" \
            --overwrite
      - name: Upload model_gb.pkl via SAS (no login)
        if: ${{ secrets.STORAGE_SAS_TOKEN != '' && hashFiles('models/model_gb.pkl') != '' }}
        run: |
          az storage blob upload \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --container-name models \
            --name model_gb.pkl \
            --file models/model_gb.pkl \
            --sas-token "${{ secrets.STORAGE_SAS_TOKEN }}" \
            --overwrite
      - name: Upload predictions.csv via SAS (no login)
        if: ${{ secrets.STORAGE_SAS_TOKEN != '' && hashFiles('data/processed/predictions.csv') != '' }}
        run: |
          az storage blob upload \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --container-name cleaned-data \
            --name predictions.csv \
            --file data/processed/predictions.csv \
            --sas-token "${{ secrets.STORAGE_SAS_TOKEN }}" \
            --overwrite

  deploy-to-azure:
    runs-on: ubuntu-latest
    needs: upload-artifacts
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Deploy with Publish Profile (no login)
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
          package: .
      - name: Print App URL
        run: echo "App URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
