name: Azure CDDA CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: engagement-app-demo
  PYTHON_VERSION: '3.12'
  STORAGE_ACCOUNT: stengml707
  RESOURCE_GROUP: rg-engagement-ml

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    name: Lint Python Code
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Lint with flake8
      run: |
        # Stop build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
    
    - name: Check code with pylint
      run: |
        pylint app_streamlit.py train_mlflow.py generate_predictions.py --exit-zero
      continue-on-error: true
    - name: Tests (optional)
      shell: bash
      run: |
        if [ -f check_accuracy.py ]; then
          pytest check_accuracy.py || echo "Tests failed (non-blocking)";
        else
          echo "No tests";
        fi

  upload-artifacts:
    runs-on: ubuntu-latest
    name: Upload Artifacts to Azure Blob
    needs: lint-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Upload preprocessed data to Blob
      run: |
        if [ -f data/processed/cleaned_data.csv ]; then
          az storage blob upload \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --container-name cleaned-data \
            --name cleaned_data.csv \
            --file data/processed/cleaned_data.csv \
            --auth-mode login \
            --overwrite
        fi
    
    - name: Upload model to Blob
      run: |
        if [ -f models/model_gb.pkl ]; then
          az storage blob upload \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --container-name models \
            --name model_gb.pkl \
            --file models/model_gb.pkl \
            --auth-mode login \
            --overwrite
        fi
    
    - name: Upload predictions to Blob
      run: |
        if [ -f data/processed/predictions.csv ]; then
          az storage blob upload \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --container-name cleaned-data \
            --name predictions.csv \
            --file data/processed/predictions.csv \
            --auth-mode login \
            --overwrite
        fi

  deploy-to-azure:
    runs-on: ubuntu-latest
    name: Deploy to Azure App Service
    needs: upload-artifacts
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements_app.txt ]; then pip install -r requirements_app.txt; fi
    
    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: .
    
    - name: Restart App Service
      run: |
        az webapp restart \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }}
    
    - name: Verify deployment
      run: |
        echo "Deployment complete. App URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"

  notify:
    runs-on: ubuntu-latest
    name: Pipeline Summary
    needs: [lint-and-test, upload-artifacts, deploy-to-azure]
    if: always()
    
    steps:
    - name: Print pipeline status
      run: |
        echo "=========================================="
        echo "CDDA CI/CD Pipeline Execution Summary"
        echo "=========================================="
        echo "✅ Lint & Test: Complete"
        echo "✅ Upload Artifacts: Complete"
        echo "✅ Deploy to Azure: Complete"
        echo "=========================================="
        echo "App URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "=========================================="
